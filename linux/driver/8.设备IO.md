

# IO访问-------访问外设控制器的寄存器

![SOC架构图](img/SOC架构图.jpg)


两种方式：

1. IO端口：X86上使用
2. IO map：外设寄存器在SOC芯片手册上都有相应物理地址

IO内存访问接口：

```c
#include <linux/io.h>
static inline void __iomem *ioremap(unsigned long pa, unsigned long size)
/*
功能：实现IO管脚的映射
参数：pa:该管脚的偏移地址
	 Size:该管脚映射空间的大小
返回值：成功返回映射的虚拟地址,失败NULL
*/

static inline void iounmap(volatile void __iomem *addr)
/*
功能：解除io管脚的映射
参数：addr:io管脚映射的地址
*/

unsigned readb(void *addr);//1字节   或ioread8(void *addr)
unsigned readw(void *addr);//2字节   或ioread16(void *addr)
unsigned readl(void *addr);//4字节   或ioread32(void *addr)
/*
功能：读取寄存器的值
参数：addr  地址
返回值：读到的数据
*/

void writeb(unsigned value, void *addr);//1字节   或iowrite8(u8 value, void *addr)
void writew(unsigned value, void *addr);//2字节  或iowrite16(u16 value, void *addr)
void writel(unsigned value, void *addr);//4字节  或iowrite32(u32 value, void *addr)
/*
 功能：向指定的寄存器中，写入数据。
 参数：value：待写入寄存器中的数据
	  Address：寄存器的虚拟地址
*/
```

# 四、led驱动


2. 查阅SOC芯片手册

   ![GPX2_7寄存器](img/GPX2_7寄存器.jpg)

GPX2_7设置参考：
   |寄存器名称|地址|设置|数值|
   |-|-|-|-|
   |GPX2CON|0x11000C40|31-28位|0001|
   |GPX2DAT|0x11000C44|7位||


3. 编写驱动

   a. 设计设备数据类型

   ```c
   struct myled_dev
   {
   	struct cdev mydev;
       
       unsigned long * led2con;
       unsigned long * led2dat;
   };
   ```

   b. 考虑需要支持的函数

   c. 模块入口：ioremap + 设置成输出

   d. 模块出口：iounmap

   e. 编写关灯函数和开灯函数，实现ioctl

   f.[参考 arm LED](../../arm/code/led.c)



1. 读原理图

   ![led原理图](img/led原理图.jpg)




