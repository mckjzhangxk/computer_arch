 
 ## 传统BIOS启动的流程

BIOS启动流程的简要说明如下：

- 上电自检（POST）

- 寻找启动设备：BIOS根据预设的启动顺序（通常可以在BIOS设置中配置）寻找可启动设备，如硬盘、光驱、U盘等。

- 读取MBR：一旦找到启动设备，BIOS会读取该设备的主引导记录（MBR，Master Boot Record）。MBR位于硬盘的第一个扇区（扇区0，柱面0，磁头0）。

- <font color=red>检查MBR签名：BIOS会检查MBR的最后两个字节是否为0x55和0xAA。如果签名不正确，BIOS会尝试下一个启动设备。

- 执行引导程序：如果MBR签名正确，BIOS会将MBR中的引导程序加载到内存中并执行。MBR中的引导程序通常只有446字节，它的任务是找到并加载操作系统的引导加载程序（如GRUB、LILO等）。</font>

<font color=pink>BIOS不关心MBR中的分区表条目的引导标志（boot flag）。引导标志是操作系统和引导加载程序用来标识活动分区的，BIOS只关心MBR的引导签名。</font>

总结来说，BIOS在读取MBR后，只检查MBR末尾是否为0x55AA，然后执行MBR中的引导程序，而不关心分区表条目的引导标志。

## 解析MBR格式

MBR（Master Boot Record，主引导记录）是存储在磁盘的第一个扇区（LBA 0）的引导扇区。它包含了引导加载程序和分区表信息。MBR的结构如下：

1. **引导程序（Bootloader）**：
    - 大小：446字节
    - 作用：包含引导加载程序代码，用于启动操作系统。

2. **分区表（Partition Table）**：
    - 大小：64字节
    - 作用：包含四个分区条目，每个条目16字节，描述磁盘的分区信息。

3. **结束标志（Boot Signature）**：
    - 大小：2字节
    - 作用：固定值0x55AA，表示这是一个有效的MBR。

### MBR结构示意图

| 偏移量 (字节) | 大小 (字节) | 描述 |
|---------------|-------------|------|
| 0             | 446         | 引导程序 |
| 446           | 16          | 分区条目1 |
| 462           | 16          | 分区条目2 |
| 478           | 16          | 分区条目3 |
| 494           | 16          | 分区条目4 |
| 510           | 2           | 结束标志 (0x55AA) |

### 分区条目结构

每个分区条目的结构如下：

| 偏移量 (字节) | 大小 (字节) | 描述 |
|---------------|-------------|------|
| 0             | 1           | 引导标志（0x80表示可引导，0x00表示不可引导） |
| 1             | 3           | 起始CHS地址 |
| 4             | 1           | 分区类型 |
| 5             | 3           | 结束CHS地址 |
| 8             | 4           | 起始LBA地址 |
| 12            | 4           | 分区大小（以扇区为单位） |

### 示例

以下是一个MBR的十六进制示例：

```

                                                     ^1
000001b0  cd 10 ac 3c 00 75 f4 c3  70 f6 a9 cf 00 00 80 41  
000001c0  02 00 07 fe ff ff 00 10  00 00 00 10 00 0a 00 fe  
000001d0  ff ff 0f fe ff ff fe 2f  00 0a 02 38 60 6a 00 fe  
000001e0  ff ff 0b fe ff ff 00 68  60 74 00 00 10 00 00 00  
000001f0  00 00 00 00 00 00 00 00  00 00 00 00 00 00 55 aa


条目1：[80] 41 02 00 [07] fe ff ff [00 10  00 00] [00 10 00 0a]
    是否引导：80
    类型:07
    起点（LBA）： 0x1000=4096
    扇区大小：0a001000=80G

条目2：[00] fe ff ff [0f] fe ff ff [fe 2f  00 0a] [02 38 60 6a]

    类型:0f
    起点（LBA）：0xa002ffe
    扇区大小：6a603902= 851G

条目3：[00] fe ff ff [0b] fe ff ff [00 68  60 74] [00 00 10 00]
    类型:0b
    起点（LBA）0x74606800
    扇区大小：100000= 512M
条目4：00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 
```

在这个示例中，分区表从偏移量<font color=red>0x1BE</font>开始，结束标志0x55AA位于偏移量0x1FE和0x1FF。


### CHS地址和LBA地址

#### CHS地址
CHS（Cylinder-Head-Sector，柱面-磁头-扇区）是一种早期的磁盘寻址方式。它使用柱面号、磁头号和扇区号来定位磁盘上的数据。具体含义如下：
- **柱面（Cylinder）**：磁盘上的一个圆柱面，由多个磁道组成。
- **磁头（Head）**：磁盘上的一个读写磁头。
- **扇区（Sector）**：磁盘上的一个数据块，通常为512字节。

#### LBA地址
LBA（Logical Block Addressing，逻辑块地址）是一种现代的磁盘寻址方式。它将磁盘看作一个线性的块序列，每个块都有一个唯一的编号。LBA地址简化了磁盘寻址，避免了CHS寻址的复杂性。

#### CHS与LBA的转换
在现代计算机中，LBA已经取代了CHS作为主要的磁盘寻址方式。以下是CHS与LBA的转换公式：
- **LBA = (C × Hpc + H) × Spt + (S - 1)**
    - C：柱面号
    - H：磁头号
    - S：扇区号
    - Hpc：每柱面的磁头数
    - Spt：每磁道的扇区数

这种转换方式使得LBA地址可以唯一地表示磁盘上的每一个扇区。

### 示例
假设一个磁盘有16个磁头，每个磁道有63个扇区，以下是一个CHS地址的示例：
- **CHS地址**：C=1, H=0, S=1
- **对应的LBA地址**：LBA = (1 × 16 + 0) × 63 + (1 - 1) = 1008

通过这种方式，可以将CHS地址转换为LBA地址，从而简化磁盘数据的定位和访问。


## 使用Qemu模拟Bios执行引导程序


```sh
dd if=/dev/sda of=mbr.bin bs=512 count=1
# -boot order=c 是让Bios从磁盘启动。
# -drive format=raw,file=mbr.bin是 指定磁盘
qemu-system-x86_64 -drive format=raw,file=mbr.bin  -boot order=c -S -s

gdb
target remote :1234
b *0x7c00  #因为bios会把mbr加载在这个地址。
```